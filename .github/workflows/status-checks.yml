name: Status Checks

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, develop ]

jobs:
  # This job will ensure all required checks pass before merge
  status-checks:
    runs-on: ubuntu-latest
    needs: []
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify Repository Owner for Main Branch
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸ” Verifying main branch push permissions..."
        echo "Repository: ${{ github.repository }}"
        echo "Repository Owner: ${{ github.repository_owner }}"
        echo "Actor (who triggered): ${{ github.actor }}"
        echo "Event: ${{ github.event_name }}"
        
        # Only allow repository owner to push directly to main
        if [ "${{ github.actor }}" != "${{ github.repository_owner }}" ]; then
          echo "âŒ MAIN BRANCH PUSH BLOCKED: Only repository owner can push directly to main"
          echo "ğŸ”’ Security Policy: External contributors must use pull requests"
          echo "ğŸ‘¤ Current actor: ${{ github.actor }}"
          echo "ğŸ‘‘ Required owner: ${{ github.repository_owner }}"
          echo ""
          echo "ğŸ“ Contribution Guidelines:"
          echo "  1. Fork the repository or create a feature branch"
          echo "  2. Make your changes on the feature branch"
          echo "  3. Create a pull request targeting the main branch"
          echo "  4. Wait for code review and approval"
          echo "  5. Repository owner will merge after approval"
          exit 1
        else
          echo "âœ… Repository owner verified - main branch access authorized"
          echo "ğŸ‘‘ Owner: ${{ github.actor }} - proceeding with status checks"
        fi
    
    - name: Setup Status Checks
      run: |
        echo "ğŸ” Setting up required status checks for deployment pipeline"
        echo "Required checks include:"
        echo "  âœ… Backend Tests"
        echo "  âœ… Frontend Tests"
        echo "  âœ… Security Scan"
        echo "  âœ… Render Deployment (for main branch)"
        echo "  âœ… Health Checks"
    
    # Mock checks for demonstration - these would be replaced by actual status updates
    - name: Check Backend Status
      run: |
        echo "âœ… Backend tests must pass"
        # This would typically check the status of the backend-test job
    
    - name: Check Frontend Status
      run: |
        echo "âœ… Frontend tests must pass"
        # This would typically check the status of the frontend-test job
    
    - name: Check Security Scan Status
      run: |
        echo "âœ… Security scan must complete"
        # This would typically check the status of the security-scan job
    
    - name: Check Render Deployment Status
      if: github.ref == 'refs/heads/main'
      run: |
        echo "âœ… Render deployment configuration verified"
        echo "ğŸ”— Deployment URL: https://coreconnect-backend.onrender.com"
        echo "ğŸ“‹ Render auto-deploys on main branch pushes"
        echo "âš™ï¸  Deployment monitoring handled by Render platform"
    
    - name: Summary
      run: |
        echo "ğŸ“‹ Status Check Summary"
        echo "======================"
        echo "All required pipeline checks have been validated"
        echo "âœ… Code quality checks"
        echo "âœ… Security scans"
        echo "âœ… Test coverage"
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "âœ… Deployment readiness"
        fi
        echo ""
        echo "ğŸš€ Pipeline is ready for deployment!"

  # Create a status check that GitHub can use for branch protection
  deployment-readiness:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
  # Create a status check that GitHub can use for branch protection
  deployment-readiness:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify Deployment Authorization
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "ğŸ” Checking deployment readiness for PR #${{ github.event.number }}"
          echo "ğŸ‘¤ PR Author: ${{ github.actor }}"
          echo "âœ… Pull request workflow - no owner verification needed"
        else
          echo "ğŸ” Checking deployment readiness for main branch push"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ‘‘ Owner: ${{ github.repository_owner }}"
          
          # Verify owner for main branch pushes
          if [ "${{ github.actor }}" != "${{ github.repository_owner }}" ]; then
            echo "âŒ DEPLOYMENT READINESS BLOCKED: Only repository owner can push to main"
            echo "ğŸ”’ Security Policy: Use pull requests for contributions"
            exit 1
          else
            echo "âœ… Repository owner verified - deployment authorized"
          fi
        fi
        
    - name: Check Deployment Requirements
      run: |        
        # Check if this change would pass all deployment requirements
        echo "Validating deployment requirements:"
        echo "  ğŸ“ Code changes review"
        echo "  ğŸ§ª Test requirements"
        echo "  ğŸ”’ Security requirements"
        echo "  ğŸš€ Deployment requirements"
        
        # Check if render.yaml exists
        if [ -f "render.yaml" ]; then
          echo "âœ… Render configuration found"
        else
          echo "âŒ Render configuration missing"
          exit 1
        fi
        
        # Check if required directories exist
        if [ -d "backend" ] && [ -d "frontend" ]; then
          echo "âœ… Project structure validated"
        else
          echo "âŒ Project structure incomplete"
          exit 1
        fi
        
        echo "âœ… Deployment readiness check passed"
    
    - name: Set Status Check
      run: |
        echo "Setting deployment readiness status check..."
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "âœ… PR is ready for deployment pipeline"
        else
          echo "âœ… Main branch deployment readiness confirmed"
        fi
