name: Security Policy Enforcement

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  enforce-security-policy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Display Security Policy
      run: |
        echo "ğŸ” CoreConnect Repository Security Policy"
        echo "========================================"
        echo ""
        echo "ğŸ“‹ Access Control Rules:"
        echo "  ğŸ‘‘ Repository Owner: ${{ github.repository_owner }}"
        echo "  ğŸ¢ Repository: ${{ github.repository }}"
        echo "  ğŸ“… Policy Effective: $(date)"
        echo ""
        echo "ğŸš¨ Main Branch Protection:"
        echo "  âœ… Only repository owner can push directly to main"
        echo "  âœ… All external contributors must use pull requests"
        echo "  âœ… Deployment workflows require owner authorization"
        echo "  âœ… Production deployments are owner-restricted"
        echo ""
        echo "ğŸ“ Contribution Workflow for External Contributors:"
        echo "  1ï¸âƒ£  Fork the repository or create a feature branch"
        echo "  2ï¸âƒ£  Implement changes on your branch"
        echo "  3ï¸âƒ£  Create a pull request targeting main branch"
        echo "  4ï¸âƒ£  Wait for code review and approval"
        echo "  5ï¸âƒ£  Repository owner will merge and deploy"
        echo ""
        echo "ğŸ” Current Event Details:"
        echo "  Event Type: ${{ github.event_name }}"
        echo "  Triggered By: ${{ github.actor }}"
        echo "  Target Branch: ${{ github.ref }}"
    
    - name: Validate Access Permissions
      run: |
        echo "ğŸ” Validating access permissions..."
        
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ğŸ“‹ Main branch push detected - validating permissions"
          
          if [ "${{ github.actor }}" = "${{ github.repository_owner }}" ]; then
            echo "âœ… AUTHORIZED: Repository owner push to main branch"
            echo "ğŸ‘‘ Owner: ${{ github.actor }}"
            echo "ğŸš€ Deployment workflows will proceed"
          else
            echo "âŒ UNAUTHORIZED: Non-owner push to main branch detected"
            echo "ğŸ‘¤ Actor: ${{ github.actor }}"
            echo "ğŸ‘‘ Owner: ${{ github.repository_owner }}"
            echo "ğŸ”’ This violates the security policy"
            
            echo ""
            echo "ğŸš¨ SECURITY POLICY VIOLATION"
            echo "============================="
            echo "Only the repository owner is authorized to push directly to the main branch."
            echo "This policy ensures:"
            echo "  â€¢ Code quality through required reviews"
            echo "  â€¢ Deployment security and control" 
            echo "  â€¢ Audit trail for production changes"
            echo ""
            echo "Please use the pull request workflow for contributions."
            exit 1
          fi
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "âœ… VALID: Pull request workflow detected"
          echo "ğŸ‘¤ PR Author: ${{ github.actor }}"
          echo "ğŸ” Pull requests are welcome from all contributors"
          echo "ğŸ“ Changes will be reviewed before merge"
        else
          echo "âœ… VALID: Non-main branch activity or scheduled workflow"
          echo "ğŸ” No special restrictions apply"
        fi
    
    - name: Security Policy Summary
      if: always()
      run: |
        echo "ğŸ“Š Security Policy Enforcement Summary"
        echo "======================================"
        echo "ğŸ” Policy Status: ${{ job.status }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸ“… Check Time: $(date)"
        echo "ğŸ” Event: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          if [ "${{ github.actor }}" = "${{ github.repository_owner }}" ]; then
            echo "âœ… Authorized main branch deployment by owner"
          else
            echo "âŒ Blocked unauthorized main branch push"
          fi
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "âœ… Pull request workflow - security policy compliant"
        fi
        
        echo ""
        echo "ğŸ›¡ï¸  Security measures active and enforcing policy compliance"
